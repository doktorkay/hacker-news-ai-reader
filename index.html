<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hacker News Reader</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 64 64%22><rect width=%2264%22 height=%2264%22 fill=%22%23F0EFE7%22 rx=%2212%22/><text x=%2250%25%22 y=%2255%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22sans-serif%22 font-weight=%22bold%22 font-size=%2232%22 fill=%22%2310110E%22>HK</text></svg>">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kumbh+Sans:wght@100..900&display=swap" rel="stylesheet">

    <style>
        /* --- PALETTE & VARIABLES --- */
        :root {
            --ink-black: #10110E;    
            --ink-grey: #8B8C84;     
            --paper-dark: #E0E0D4;    
            --paper-light: #F0EFE7;   
            --paper-white: #fefefe;   
            --radius-soft: 12px;      
        }

        /* --- RESET & TYPOGRAPHY --- */
        body {
            font-family: "Kumbh Sans", sans-serif;
            background-color: var(--paper-light);
            color: var(--ink-black);
            margin: 0;
            padding: 30px 20px;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        a { color: inherit; text-decoration: none; }
        
        /* --- HEADER --- */
        header {
            max-width: 630px; 
            margin: 0 auto 40px auto;
            display: flex; justify-content: space-between; align-items: flex-start;
        }

        .header-content h1 {
            margin: 0; font-size: 2rem; font-weight: 700;
            letter-spacing: -1px; color: var(--ink-black); line-height: 1.1;
        }

        .header-meta {
            margin-top: 10px; font-size: 0.9rem; color: var(--ink-grey);
            font-weight: 500; display: flex; align-items: center; gap: 10px;
        }

        #status-indicator {
            width: 8px; height: 8px; background-color: var(--ink-grey); 
            border-radius: 50%; display: inline-block; transition: background-color 0.3s;
        }

        /* --- CONTROLS --- */
        .header-controls { display: flex; gap: 12px; }

        .icon-btn {
            width: 44px; height: 44px;
            border: 1px solid var(--ink-grey);
            background-color: transparent; color: var(--ink-black);
            border-radius: var(--radius-soft); cursor: pointer;
            font-size: 1.2rem; display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease;
        }
        .icon-btn:hover { background-color: var(--ink-black); color: var(--paper-white); transform: translateY(-2px); }
        .icon-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        #clear-btn { border-color: transparent; color: var(--ink-grey); }
        #clear-btn:hover { background-color: #dacacace; color: var(--ink-black); }

        /* --- NEWS CONTAINER --- */
        #news-container {
            max-width: 630px; 
            margin: 0 auto; 
            display: flex; 
            flex-direction: column;
            gap: 30px;
        }

        /* --- WRAPPER STRUCTURE (DOT + CARD) --- */
        .news-item-wrapper {
            display: flex;
            gap: 15px;
            align-items: flex-start;
            width: 100%;
        }

        /* --- STATUS DOT --- */
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--ink-black); /* Status: UNREAD */
            margin-top: 35px; 
            flex-shrink: 0;
            transition: background-color 0.3s ease;
        }

        .status-dot.read {
            background-color: #d1d1d1; /* Status: READ */
            opacity: 0.5;
        }

        /* Adjust dot position for compact cards */
        .news-item-wrapper:has(.news-card.compact) .status-dot {
             margin-top: 25px;
        }

        /* --- PAPER CARD STYLE --- */
        .news-card {
            flex-grow: 1; 
            background-color: var(--paper-dark);
            border-radius: var(--radius-soft);
            padding: 30px;
            position: relative;
            transition: all 0.3s ease;
            scroll-margin-top: 20px;
            width: 0; /* Flexbox trick for text overflow */
        }
        
        .news-card.read-status { background-color: #E8E7DF; }

        /* --- COMPACT MODE --- */
        .news-card.compact {
            padding: 15px 20px;
            display: flex; align-items: center; gap: 15px;
            opacity: 0.8; cursor: pointer;
        }

        /* Hide elements in compact mode */
        .news-card.compact .news-abstract,
        .news-card.compact .actions,
        .news-card.compact .ai-response,
        .news-card.compact .news-category,
        .news-card.compact .news-header-group { display: none; }

        .compact-header { display: none; flex: 1; align-items: center; justify-content: space-between; }
        .news-card.compact .compact-header { display: flex; }

        .compact-info { display: flex; flex-direction: column; width: 100%; }
        .compact-title { font-weight: 700; font-size: 1.1rem; color: var(--ink-black); margin: 0; }
        .compact-date { font-size: 0.8rem; color: var(--ink-grey); margin-top: 4px; }
        
        .toggle-view-btn {
            background: transparent; border: 1px solid var(--ink-grey);
            border-radius: 50%; width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--ink-black); transition: 0.2s; flex-shrink: 0; margin-left: 15px;
        }
        .toggle-view-btn:hover { background-color: var(--ink-black); color: white; }

        /* --- FULL MODE --- */
        .news-category {
            font-size: 0.75rem; font-weight: 700; letter-spacing: 1px;
            text-transform: uppercase; color: var(--ink-grey);
            margin-bottom: 12px; display: block;
        }

        .news-header-group {
            display: flex; justify-content: space-between;
            align-items: flex-start; gap: 20px; margin-bottom: 20px;
        }

        .news-title { margin: 0; font-size: 1.5rem; font-weight: 700; line-height: 1.2; color: var(--ink-black); }
        .news-title a {
            color: var(--ink-black); text-decoration: none;
            background-image: linear-gradient(to right, var(--ink-black), var(--ink-black));
            background-size: 0% 2px; background-repeat: no-repeat;
            background-position: left bottom; transition: background-size 0.3s; padding-bottom: 2px;
        }
        .news-title a:hover { background-size: 100% 2px; }

        .news-author {
            font-size: 0.9rem;
            color: var(--ink-grey);
            margin-top: 6px;
            font-weight: 500;
        }

        .news-img {
            width: 70px; height: 70px; object-fit: cover;
            border-radius: var(--radius-soft);
            background-color: var(--ink-black);
            display: flex; align-items: center; justify-content: center;
            color: var(--paper-light); font-weight: bold; flex-shrink: 0;
        }

        .news-abstract {
            font-size: 1.05rem; color: var(--ink-grey);
            margin-bottom: 25px; font-weight: 400; line-height: 1.6;
            display: -webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical; overflow: hidden;
        }

        .actions {
            display: flex; gap: 15px; border-top: 1px solid rgba(139, 140, 132, 0.2);
            padding-top: 20px; flex-wrap: wrap; align-items: center;
        }

        .action-btn {
            background-color: transparent; color: var(--ink-black);
            border: 1px solid var(--ink-black);
            padding: 10px 20px; border-radius: 30px;
            cursor: pointer; font-size: 0.85rem; font-weight: 600;
            font-family: "Kumbh Sans", sans-serif; transition: all 0.2s;
        }
        .action-btn:hover { background-color: var(--ink-black); color: var(--paper-white); }
        .action-btn.active-btn { background-color: var(--ink-black); color: var(--paper-white); }

        .ai-response {
            margin-top: 25px; background-color: var(--paper-white);
            padding: 30px; border-radius: var(--radius-soft);
            display: none; font-size: 1rem; color: var(--ink-black);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative;
        }

        .close-ai {
            position: absolute; top: 15px; right: 15px;
            background: transparent; border: none; color: var(--ink-grey);
            cursor: pointer; font-size: 1.5rem; line-height: 1;
        }
        .close-ai:hover { color: var(--ink-black); }

        /* MARKDOWN STYLES */
        .ai-response h1, .ai-response h2, .ai-response h3 {
            color: var(--ink-black); margin-top: 20px; margin-bottom: 10px;
            font-weight: 700; font-size: 1.2rem;
        }
        .ai-response strong { font-weight: 800; }
        .ai-response ul, .ai-response ol { padding-left: 20px; color: var(--ink-grey); }
        .ai-response li { margin-bottom: 8px; }
        .ai-response p { margin-bottom: 15px; color: #444; }
        
        .loading { color: var(--ink-grey); font-style: italic; }

        .close-bottom-btn {
            display: block; width: 100%; text-align: center; margin-top: 30px; padding-top: 15px;
            border: none; border-top: 1px dashed var(--ink-grey);
            background: transparent; color: var(--ink-grey); cursor: pointer;
            font-family: "Kumbh Sans", sans-serif; font-size: 0.9rem; transition: color 0.2s;
        }
        .close-bottom-btn:hover { color: var(--ink-black); }

        @media (max-width: 600px) {
            body { padding: 20px 15px; }
            .news-card { padding: 20px; }
            .header-content h1 { font-size: 1.75rem; }
            .news-item-wrapper { gap: 10px; }
        }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

    <header>
        <div class="header-content">
            <h1>Hacker News</h1>
            <div class="header-meta">
                <span id="status-indicator"></span>
                <span id="status-text">Ready</span>
            </div>
        </div>
        
        <div class="header-controls">
            <button id="reload-btn" class="icon-btn" title="Reload">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
            </button>
            <button id="clear-btn" class="icon-btn" title="Clear All">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
            </button>
        </div>
    </header>

    <div id="news-container"></div>

    <script>
        // --- GEMINI CONFIGURATION ---
        // INSERT YOUR GOOGLE API KEY HERE
        const GEMINI_API_KEY = 'INSERT_YOUR_KEY_HERE'; 
        
        // Gemini Model
        const AI_MODEL = 'gemini-3-flash-preview'; 
        
        // --- ENDPOINTS ---
        const HN_BASE_URL = 'https://hacker-news.firebaseio.com/v0';
        const CONTENT_PROXY = 'https://api.codetabs.com/v1/proxy?quest=';
        
        const MAX_NEWS = 30; 
        const DB_NAME = 'ink_hn_db_v1'; // DB Name

        let newsDB = [];
        const delay = ms => new Promise(res => setTimeout(res, ms));

        // --- INITIALIZATION ---
        window.onload = function() {
            loadFromLocalStorage();
            renderNews();
            
            document.getElementById('reload-btn').onclick = fetchAndUpdateNews;
            document.getElementById('clear-btn').onclick = function() {
                if(confirm("Do you want to clear all saved stories?")) {
                    newsDB = [];
                    localStorage.removeItem(DB_NAME);
                    renderNews();
                    updateStatus("Library cleared.");
                }
            };
        };

        function updateStatus(msg) {
            const txt = document.getElementById('status-text');
            const dot = document.getElementById('status-indicator');
            if(txt) txt.textContent = msg;
            dot.style.backgroundColor = msg.includes("...") ? "#F4A261" : "var(--ink-black)";
        }

        // --- DATABASE ---
        function loadFromLocalStorage() {
            try {
                const stored = localStorage.getItem(DB_NAME);
                if (stored) {
                    newsDB = JSON.parse(stored);
                    // Force compact view on load
                    newsDB.forEach(n => n.isCompact = true);
                }
            } catch(e) { console.error("DB Error", e); }
        }

        function saveToLocalStorage() {
            localStorage.setItem(DB_NAME, JSON.stringify(newsDB));
        }

        // --- GEMINI API HELPER ---
        async function callGemini(promptText) {
            if (!GEMINI_API_KEY || GEMINI_API_KEY === 'INSERT_YOUR_KEY_HERE') {
                console.error("Missing API Key");
                alert("Please configure your API Key in the code.");
                return null;
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${AI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
            
            const payload = {
                contents: [{
                    parts: [{ text: promptText }]
                }]
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);
                
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini Error:", error);
                throw error;
            }
        }


        // --- FETCH HACKER NEWS ---
        async function fetchAndUpdateNews() {
            const btn = document.getElementById('reload-btn');
            btn.style.opacity = 0.5; btn.disabled = true;
            updateStatus("Fetching Top Stories...");

            try {
                const responseIds = await fetch(`${HN_BASE_URL}/topstories.json`);
                if (!responseIds.ok) throw new Error("HN API Error");
                const allIds = await responseIds.json();
                const topIds = allIds.slice(0, MAX_NEWS);
                
                let addedCount = 0;
                
                for (let i = topIds.length - 1; i >= 0; i--) {
                    const id = topIds[i];
                    const exists = newsDB.some(news => news.hnId === id);
                    
                    if (!exists) {
                        addedCount++;
                        updateStatus(`Downloading story ${addedCount}/${topIds.length}...`);
                        
                        const itemRes = await fetch(`${HN_BASE_URL}/item/${id}.json`);
                        const item = await itemRes.json();
                        
                        if(!item || item.type !== 'story') continue;

                        let finalTitle = item.title;
                        let finalContent = item.text ? item.text : ""; 
                        let urlToUse = item.url ? item.url : `https://news.ycombinator.com/item?id=${id}`;

                        // Title Translation/Refinement
                        // NOTE: Change "English" to "Italian" below if you prefer Italian titles
                        try {
                            await delay(200); 
                            const prompt = `You are a tech translator. Translate the following technical title to English (if not already), keeping technical terms intact. Reply ONLY with the translated title.\n\nTitle: ${item.title}`;
                            
                            const translation = await callGemini(prompt);
                            if (translation) finalTitle = translation.trim();
                        } catch (e) { console.warn("Translation skipped", e); }

                        let domain = "HN";
                        try { if(item.url) domain = new URL(item.url).hostname.replace('www.','').split('.')[0].toUpperCase().substring(0,2); } catch(e){}

                        newsDB.unshift({
                            hnId: item.id,
                            title: finalTitle, 
                            originalTitle: item.title, 
                            author: item.by || "Unknown", 
                            link: urlToUse, 
                            pubDate: item.time * 1000, 
                            imageShort: domain, 
                            content: finalContent, 
                            isRead: false,
                            isCompact: true, 
                            cachedSummary: null, cachedExplanation: null
                        });
                        renderNews();
                    }
                }
                
                if (newsDB.length > 50) newsDB = newsDB.slice(0, 50);
                saveToLocalStorage();
                updateStatus(addedCount > 0 ? `Done. ${addedCount} new stories.` : "No new stories.");
            } catch (error) {
                alert("Error: " + error.message);
                updateStatus("Update failed.");
            } finally {
                btn.disabled = false; btn.style.opacity = 1;
            }
        }

        // --- RENDER ---
        function renderNews() {
            const container = document.getElementById('news-container');
            container.innerHTML = '';

            if (newsDB.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding: 40px; border: 1px dashed var(--ink-grey); border-radius: var(--radius-soft); color: var(--ink-grey);">
                        Your library is empty.<br>Click the reload icon above.
                    </div>`;
                return;
            }

            newsDB.forEach((news, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'news-item-wrapper';

                const dot = document.createElement('div');
                dot.id = `dot-${index}`;
                dot.className = news.isRead ? 'status-dot read' : 'status-dot';

                const card = document.createElement('div');
                card.id = `card-${index}`;
                
                const shouldBeCompact = (news.isCompact !== undefined) ? news.isCompact : news.isRead;
                const authorStr = news.author ? news.author : 'Hacker News';
                
                let classes = 'news-card';
                if (news.isRead) classes += ' read-status'; 
                if (shouldBeCompact) classes += ' compact'; 
                
                card.className = classes;
                
                const dateObj = new Date(news.pubDate);
                const timeStr = dateObj.toLocaleDateString('en-US', { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' });
                const imgPlaceholder = news.imageShort || "HN";
                const abstractHtml = news.content ? `<div class="news-abstract">${news.content}</div>` : '';

                card.innerHTML = `
                    <div class="compact-header">
                        <div class="compact-info">
                            <h3 class="compact-title">${news.title}</h3>
                            <span class="compact-date">${timeStr} &bull; by ${authorStr}</span>
                        </div>
                        <button class="toggle-view-btn" onclick="toggleCardView(${index})" title="Expand">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </button>
                    </div>

                    <span class="news-category">HACKER NEWS &bull; ${timeStr}</span>
                    <div class="news-header-group">
                        <div style="flex:1">
                            <h2 class="news-title">
                                <a href="${news.link}" target="_blank" onclick="markAsRead(${index})">${news.title}</a>
                            </h2>
                            <div class="news-author">by ${authorStr}</div>
                        </div>
                        <div class="news-img">${imgPlaceholder}</div>
                    </div>
                    
                    ${abstractHtml}
                    
                    <div class="ai-response" id="ai-area-${index}"></div>
                    
                    <div class="actions">
                        <button class="action-btn" id="btn-sum-${index}" onclick="toggleAI(${index}, 'summarize')">Summarize</button>
                        <button class="action-btn" id="btn-expl-${index}" onclick="toggleAI(${index}, 'explain')">Explain</button>
                        
                        <button class="toggle-view-btn" onclick="toggleCardView(${index})" title="Compact" style="border-radius:50%; margin-left:auto; border:1px solid var(--ink-black)">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                        </button>
                    </div>
                `;
                
                wrapper.appendChild(dot);
                wrapper.appendChild(card);
                container.appendChild(wrapper);
            });
        }

        // --- MARK AS READ HANDLER ---
        function markAsRead(index) {
            if (!newsDB[index].isRead) {
                newsDB[index].isRead = true;
                saveToLocalStorage();

                const card = document.getElementById(`card-${index}`);
                const dot = document.getElementById(`dot-${index}`);
                
                if (card) card.classList.add('read-status');
                if (dot) dot.classList.add('read');
            }
        }

        // --- VIEW TOGGLE LOGIC ---
        function toggleCardView(index) {
            const card = document.getElementById(`card-${index}`);
            const dot = document.getElementById(`dot-${index}`);
            const news = newsDB[index];
            
            const isExpanding = card.classList.contains('compact');
            news.isCompact = !isExpanding;
            
            if (isExpanding) {
                // Expanding -> Mark as Read
                card.classList.remove('compact');
                
                if (!news.isRead) {
                    news.isRead = true;
                    saveToLocalStorage();
                    
                    card.classList.add('read-status');
                    if(dot) dot.classList.add('read');
                }

                card.onclick = null;
                card.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                // Collapsing
                card.classList.add('compact');
                card.onclick = (e) => { if (!e.target.closest('.toggle-view-btn')) toggleCardView(index); };
            }
        }

        function closeAiArea(index) {
            const area = document.getElementById(`ai-area-${index}`);
            area.style.display = 'none';
            const btnSum = document.getElementById(`btn-sum-${index}`);
            const btnExpl = document.getElementById(`btn-expl-${index}`);
            if(btnSum) btnSum.classList.remove('active-btn');
            if(btnExpl) btnExpl.classList.remove('active-btn');
            
            const card = document.getElementById(`card-${index}`);
            if(card) card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // --- AI LOGIC (GEMINI) ---
        async function toggleAI(index, type) {
            const news = newsDB[index];
            const area = document.getElementById(`ai-area-${index}`);
            
            // Mark as read when interacting with AI
            if (!news.isRead) news.isRead = true;
            news.isCompact = false; 
            saveToLocalStorage();

            const card = document.getElementById(`card-${index}`);
            const dot = document.getElementById(`dot-${index}`);

            if (card) {
                card.classList.add('read-status');
                card.classList.remove('compact');
                card.onclick = null;
            }
            if (dot) {
                dot.classList.add('read');
            }

            if (area.style.display === 'block' && area.dataset.currentType === type) {
                closeAiArea(index);
                return;
            }

            area.style.display = 'block';
            area.dataset.currentType = type;
            
            const btnSum = document.getElementById(`btn-sum-${index}`);
            const btnExpl = document.getElementById(`btn-expl-${index}`);
            if(btnSum) btnSum.classList.remove('active-btn');
            if(btnExpl) btnExpl.classList.remove('active-btn');
            
            const activeBtn = type === 'summarize' ? btnSum : btnExpl;
            activeBtn.classList.add('active-btn');

            const cachedContent = type === 'summarize' ? news.cachedSummary : news.cachedExplanation;
            const bottomBtnHtml = `<button class="close-bottom-btn" onclick="closeAiArea(${index})">Close section ↑</button>`;

            if (cachedContent) {
                area.innerHTML = `<button class="close-ai" onclick="closeAiArea(${index})">×</button>` + cachedContent + bottomBtnHtml;
            } else {
                await generateAndCacheAI(index, type, area);
            }
        }

        async function generateAndCacheAI(index, type, area) {
            const news = newsDB[index];
            area.innerHTML = '<span class="loading">Gemini is processing...</span>';
            let textToAnalyze = ""; let sourceWarning = "";

            try {
                const targetUrl = `https://r.jina.ai/${news.link}`;
                const proxyUrl = `${CONTENT_PROXY}${encodeURIComponent(targetUrl)}`;
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error("Proxy error");
                const rawResponse = await response.text();
                textToAnalyze = rawResponse;

                if(!textToAnalyze || textToAnalyze.length < 150 || textToAnalyze.includes("Access denied")) {
                    throw new Error("Content blocked or empty");
                }
                textToAnalyze = textToAnalyze.substring(0, 15000); 
            } catch (e) {
                console.warn("Fallback active:", e);
                textToAnalyze = `Title: ${news.title}\nURL: ${news.link}`;
                sourceWarning = "<br><br><small style='color:var(--ink-grey); font-style:italic'>(Analysis based on metadata only)</small>";
            }

            try {
                // NOTE: Change "English" to "Italian" in the prompts below if you prefer Italian output
                const prompt = type === 'summarize' 
                    ? `Create an elegant and structured summary in English (Markdown) of this text:\n\n${textToAnalyze}`
                    : `Explain in simple terms (ELI5) in English (Markdown) what happened:\n\n${textToAnalyze}`;

                const aiText = await callGemini(prompt);
                const formattedHtml = marked.parse(aiText) + sourceWarning;

                if (type === 'summarize') news.cachedSummary = formattedHtml;
                else news.cachedExplanation = formattedHtml;
                saveToLocalStorage();

                const bottomBtnHtml = `<button class="close-bottom-btn" onclick="closeAiArea(${index})">Close section ↑</button>`;
                area.innerHTML = `<button class="close-ai" onclick="closeAiArea(${index})">×</button>` + formattedHtml + bottomBtnHtml;

            } catch (e) {
                area.innerHTML = `<span style="color:var(--ink-black)">AI Error: ${e.message}</span>`;
            }
        }
    </script>
</body>
</html>